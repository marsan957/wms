{% extends "templates/web.html" %}

{% block title %}Optimerad Plockvy{% endblock %}

{% block head_include %}
<style>
	.pick-container {
		max-width: 1200px;
		margin: 20px auto;
		padding: 20px;
	}

	.pick-header {
		background: white;
		padding: 20px;
		border-radius: 8px;
		margin-bottom: 20px;
		box-shadow: 0 1px 3px rgba(0,0,0,0.1);
	}

	.pick-progress {
		background: #f8f9fa;
		padding: 15px;
		border-radius: 6px;
		margin-bottom: 20px;
	}

	.progress-bar {
		height: 40px;
		background: #e9ecef;
		border-radius: 20px;
		overflow: hidden;
		position: relative;
		margin-top: 10px;
	}

	.progress-fill {
		height: 100%;
		background: linear-gradient(90deg, #4CAF50, #45a049);
		transition: width 0.5s ease;
		display: flex;
		align-items: center;
		justify-content: center;
		color: white;
		font-weight: 600;
		font-size: 16px;
	}

	.pick-item {
		background: white;
		border: 3px solid #dee2e6;
		border-radius: 8px;
		padding: 20px;
		margin-bottom: 15px;
		transition: all 0.3s ease;
	}

	.pick-item:hover {
		border-color: #2196F3;
		box-shadow: 0 4px 8px rgba(0,0,0,0.1);
	}

	.pick-item.completed {
		background: #f0fdf4;
		border-color: #4CAF50;
	}

	.pick-item.in-progress {
		background: #fff9e6;
		border-color: #ff9800;
	}

	.item-header {
		display: flex;
		justify-content: space-between;
		align-items: center;
		margin-bottom: 15px;
	}

	.item-code {
		font-size: 20px;
		font-weight: 600;
		color: #212529;
	}

	.item-qty {
		font-size: 32px;
		font-weight: 700;
		color: #2196F3;
	}

	.item-location {
		background: #2196F3;
		color: white;
		padding: 6px 16px;
		border-radius: 16px;
		display: inline-block;
		font-weight: 600;
		margin-right: 10px;
	}

	.item-warehouse {
		color: #6c757d;
		font-size: 14px;
	}

	.btn-scan {
		width: 100%;
		padding: 16px;
		background: #4CAF50;
		color: white;
		border: none;
		border-radius: 6px;
		font-size: 18px;
		font-weight: 600;
		cursor: pointer;
		margin-top: 10px;
	}

	.btn-scan:hover {
		background: #45a049;
	}

	.btn-scan:disabled {
		background: #9e9e9e;
		cursor: not-allowed;
	}

	.step-number {
		display: inline-block;
		width: 40px;
		height: 40px;
		background: #2196F3;
		color: white;
		border-radius: 50%;
		text-align: center;
		line-height: 40px;
		font-weight: 700;
		margin-right: 15px;
	}

	.completed-check {
		color: #4CAF50;
		font-size: 32px;
		margin-left: 10px;
	}
</style>
{% endblock %}

{% block page_content %}
<div class="pick-container">
	<div class="pick-header">
		<h2 id="pick-list-title">Laddar...</h2>
		<p id="pick-list-info" class="text-muted"></p>
	</div>

	<div class="pick-progress">
		<h4>Framsteg</h4>
		<div id="progress-text">0 av 0 plockade</div>
		<div class="progress-bar">
			<div class="progress-fill" id="progress-fill" style="width: 0%">0%</div>
		</div>
	</div>

	<div id="pick-items">
		<!-- Items will be loaded here -->
	</div>
</div>

<script>
	frappe.ready(function() {
		const pick_list = window.location.pathname.split('/').pop();

		if (!pick_list) {
			frappe.msgprint('Ingen pick list specificerad');
			return;
		}

		load_pick_list(pick_list);
	});

	let pick_items = [];
	let completed_count = 0;

	function load_pick_list(pick_list_name) {
		frappe.call({
			method: 'wms.api.get_pick_list_details',
			args: { pick_list: pick_list_name },
			callback: function(r) {
				if (r.message) {
					render_pick_list(r.message);
				}
			}
		});
	}

	function render_pick_list(data) {
		// Update header
		document.getElementById('pick-list-title').textContent = 'Pick List: ' + data.name;
		document.getElementById('pick-list-info').textContent =
			data.total_items + ' artiklar • ' + data.total_qty.toFixed(2) + ' totalt';

		// Store items
		pick_items = data.items;

		// Render items
		let html = '';
		data.items.forEach((item, idx) => {
			html += `
				<div class="pick-item" id="item-${idx}" data-idx="${idx}">
					<div class="item-header">
						<div>
							<span class="step-number">${idx + 1}</span>
							<span class="item-code">${item.item_code}</span>
							<span class="completed-check" id="check-${idx}" style="display:none;">✓</span>
						</div>
						<div class="item-qty">${item.qty} ${item.uom}</div>
					</div>
					<div style="margin-left: 55px;">
						<span class="item-location">${item.warehouse}</span>
						<span class="item-warehouse">${item.location || ''}</span>
						<div style="margin-top: 10px; color: #6c757d;">
							${item.item_name}
						</div>
					</div>
					<button class="btn-scan" onclick="pick_item(${idx}, '${item.item_code}', ${item.qty})">
						Plocka
					</button>
				</div>
			`;
		});

		document.getElementById('pick-items').innerHTML = html;
		update_progress();
	}

	function pick_item(idx, item_code, qty) {
		const item_div = document.getElementById('item-' + idx);
		item_div.classList.add('in-progress');

		// Show simple confirm dialog
		frappe.prompt([
			{
				fieldname: 'confirm',
				fieldtype: 'Check',
				label: 'Bekräfta att du har plockat ' + qty + ' st av ' + item_code,
				default: 1
			}
		], function(values) {
			if (values.confirm) {
				// Mark as completed
				item_div.classList.remove('in-progress');
				item_div.classList.add('completed');
				document.getElementById('check-' + idx).style.display = 'inline';
				document.querySelector('#item-' + idx + ' .btn-scan').disabled = true;
				document.querySelector('#item-' + idx + ' .btn-scan').textContent = 'Plockad ✓';

				completed_count++;
				update_progress();

				// Play success sound
				if (typeof Audio !== 'undefined') {
					// Simple beep
					const audio_context = new (window.AudioContext || window.webkitAudioContext)();
					const oscillator = audio_context.createOscillator();
					const gain = audio_context.createGain();
					oscillator.connect(gain);
					gain.connect(audio_context.destination);
					oscillator.frequency.value = 800;
					oscillator.type = 'sine';
					gain.gain.value = 0.1;
					oscillator.start();
					oscillator.stop(audio_context.currentTime + 0.1);
				}

				// Check if all completed
				if (completed_count === pick_items.length) {
					setTimeout(function() {
						frappe.msgprint({
							title: 'Plockning Klar!',
							indicator: 'green',
							message: 'Alla ' + pick_items.length + ' artiklar har plockats. Bra jobbat!'
						});
					}, 500);
				}
			} else {
				item_div.classList.remove('in-progress');
			}
		}, 'Bekräfta Plockning');
	}

	function update_progress() {
		const total = pick_items.length;
		const percent = total > 0 ? Math.round((completed_count / total) * 100) : 0;

		document.getElementById('progress-text').textContent =
			completed_count + ' av ' + total + ' plockade';

		const fill = document.getElementById('progress-fill');
		fill.style.width = percent + '%';
		fill.textContent = percent + '%';
	}
</script>
{% endblock %}
